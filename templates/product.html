{% extends "base.html" %}

{% block title %}{{ product['Clothes Title'] or product['Title'] }} - Product Details{% endblock %}

{% block extra_head %}
<style>
/* Product Page Specific Styles */
.product-page {
    background-color: #ffffff;
    color: #000000;
}

.product-page .text-muted {
    color: #666666 !important;
}

.product-page .card {
    background-color: #ffffff;
    border: 2px solid #e5e5e5;
    color: #000000;
}

.product-page .card-body {
    color: #000000;
}

.product-page .form-control {
    background-color: #ffffff;
    border: 2px solid #e5e5e5;
    color: #000000;
}

.product-page .form-control:focus {
    background-color: #ffffff;
    border-color: #000000;
    color: #000000;
}

.product-page .btn-primary {
    background-color: #000000;
    border-color: #000000;
    color: #ffffff;
}

.product-page .btn-primary:hover {
    background-color: #333333;
    border-color: #333333;
    color: #ffffff;
}

.product-page .btn-outline-primary {
    border-color: #000000;
    color: #000000;
    background-color: #ffffff;
}

.product-page .btn-outline-primary:hover {
    background-color: #000000;
    border-color: #000000;
    color: #ffffff;
}

.product-page .badge {
    background-color: #000000;
    color: #ffffff;
}

.product-page .table {
    background-color: #ffffff;
    color: #000000;
}

.product-page .table th {
    background-color: #f8f9fa;
    color: #000000;
    border-bottom: 2px solid #000000;
}

.product-page .table td {
    color: #000000;
    border-color: #e5e5e5;
}

.product-page .alert {
    background-color: #f8f9fa;
    border: 2px solid #e5e5e5;
    color: #000000;
}

.product-page .alert-success {
    border-left: 4px solid #28a745;
}

.product-page .alert-danger {
    border-left: 4px solid #dc3545;
}
</style>
{% endblock %}

{% block content %}
<div class="container py-5 product-page" style="background-color: #ffffff; min-height: 100vh;">
    <!-- Breadcrumb -->
    <nav aria-label="breadcrumb" class="mb-5">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{{ url_for('main.home') }}" class="text-black">HOME</a></li>
            <li class="breadcrumb-item"><a href="{{ url_for('main.search') }}" class="text-black">PRODUCTS</a></li>
            {% if product['Department Name'] %}
            <li class="breadcrumb-item">
                <a href="{{ url_for('main.search', department=product['Department Name']) }}" class="text-black">{{ product['Department Name']|upper }}</a>
            </li>
            {% endif %}
            <li class="breadcrumb-item active text-black">{{ (product['Clothes Title'] or product['Title'])|upper }}</li>
        </ol>
    </nav>

    <!-- Product Header -->
    <div class="row mb-5">
        <div class="col-lg-8">
            <div class="d-flex align-items-start justify-content-between mb-4">
                <div>
                    <h1 class="display-6 fw-bold mb-3 text-black">{{ (product['Clothes Title'] or product['Title'] or 'PRODUCT')|upper }}</h1>
                    <div class="product-badges mb-3">
                        {% if product['Division Name'] %}
                            <span class="badge bg-black text-white me-2">{{ product['Division Name']|upper }}</span>
                        {% endif %}
                        {% if product['Department Name'] %}
                            <span class="badge bg-black text-white me-2">{{ product['Department Name']|upper }}</span>
                        {% endif %}
                        {% if product['Class Name'] %}
                            <span class="badge bg-black text-white">{{ product['Class Name']|upper }}</span>
                        {% endif %}
                    </div>
                </div>
                <div class="text-end">
                    <div class="rating-display mb-3">
                        {% if avg_rating > 0 %}
                            <div class="d-flex align-items-center justify-content-end">
                                {% set rating = avg_rating %}
                                {% for i in range(5) %}
                                    {% if i < rating|int %}
                                        <i class="bi bi-star-fill text-warning"></i>
                                    {% elif i < rating and (rating - i) >= 0.5 %}
                                        <i class="bi bi-star-half text-warning"></i>
                                    {% else %}
                                        <i class="bi bi-star text-muted"></i>
                                    {% endif %}
                                {% endfor %}
                            </div>
                            <small class="text-muted">Based on {{ review_count }} review{{ 's' if review_count != 1 else '' }}</small>
                        {% else %}
                            <small class="text-muted">No ratings yet</small>
                        {% endif %}
                    </div>
                </div>
            </div>
            
            <!-- Product Description -->
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-body">
                    <h5 class="card-title text-dark">
                        <i class="bi bi-info-circle"></i> Product Description
                    </h5>
                    <p class="card-text">{{ product['Clothes Description'] or 'No description available.' }}</p>
                </div>
            </div>
        </div>
        
        <div class="col-lg-4">
            <!-- Action Card -->
            <div class="card border-0 shadow-sm sticky-top">
                <div class="card-body text-center">
                    <h5 class="card-title mb-3 text-dark">
                        <i class="bi bi-heart text-danger"></i> Love this product?
                    </h5>
                    <p class="text-muted mb-4">Share your experience and help other shoppers!</p>
                    
                    <div class="d-grid gap-2">
                        <a href="{{ url_for('product.add_review_form', clothing_id=product['Clothing ID']) }}" 
                           class="btn btn-primary btn-lg">
                            <i class="bi bi-pencil-square"></i> Write a Review
                        </a>
                        
                        <button type="button" class="btn btn-outline-secondary" onclick="shareProduct()">
                            <i class="bi bi-share"></i> Share Product
                        </button>
                    </div>
                    
                    <!-- Product Stats -->
                    <div class="mt-4 pt-3 border-top">
                        <div class="row text-center">
                            <div class="col-6">
                                <div class="fw-bold text-primary">{{ review_count }}</div>
                                <small class="text-muted">Reviews</small>
                            </div>
                            <div class="col-6">
                                <div class="fw-bold text-success">{{ "%.0f"|format((reviews|selectattr('Recommended IND', 'equalto', 1)|list|length / reviews|length * 100) if reviews else 0) }}%</div>
                                <small class="text-muted">Recommend</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Reviews Section -->
    {% if reviews %}
    <div class="row">
        <div class="col">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h3 class="fw-bold">
                    <i class="bi bi-chat-square-text text-primary"></i> Customer Reviews
                    <span class="badge bg-secondary ms-2">{{ review_count }}</span>
                </h3>
                
                <!-- Review Summary -->
                <div class="text-end">
                    <div class="d-flex align-items-center mb-1">
                        <span class="me-2">Overall Rating:</span>
                        <div class="rating-stars">
                            {% set rating = avg_rating %}
                            {% for i in range(5) %}
                                {% if i < rating|int %}
                                    <i class="bi bi-star-fill text-warning"></i>
                                {% elif i < rating and (rating - i) >= 0.5 %}
                                    <i class="bi bi-star-half text-warning"></i>
                                {% else %}
                                    <i class="bi bi-star text-muted"></i>
                                {% endif %}
                            {% endfor %}
                        </div>
                    </div>
                    <small class="text-muted">{{ review_count }} total review{{ 's' if review_count != 1 else '' }}</small>
                </div>
            </div>
            
            <!-- Reviews List -->
            <div class="reviews-container" id="reviewsContainer" data-clothing-id="{{ product['Clothing ID'] }}">
                {% for review in reviews[:10] %}
                <div class="card border-0 shadow-sm mb-3{% if review.get('Is New') %} border-primary{% endif %}">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start mb-3">
                            <div>
                                <h6 class="card-title fw-bold mb-1 text-dark">
                                    {{ review['Title'] or 'Review' }}
                                    {% if review.get('Is New') %}
                                        <span class="badge bg-primary ms-2">
                                            <i class="bi bi-star"></i> New Review
                                        </span>
                                    {% endif %}
                                </h6>
                                <div class="review-rating">
                                    {% set rating = review['Rating'] %}
                                    {% for i in range(5) %}
                                        {% if i < rating|int %}
                                            <i class="bi bi-star-fill text-warning"></i>
                                        {% elif i < rating and (rating - i) >= 0.5 %}
                                            <i class="bi bi-star-half text-warning"></i>
                                        {% else %}
                                            <i class="bi bi-star text-muted"></i>
                                        {% endif %}
                                    {% endfor %}
                                </div>
                                </div>
                            </div>
                            <div class="text-end">
                                <div class="d-flex align-items-center mb-1">
                                    {% if review['Recommended IND'] == 1 %}
                                        <span class="badge bg-success">
                                            <i class="bi bi-check-circle"></i> Recommended
                                        </span>
                                    {% else %}
                                        <span class="badge bg-secondary">
                                            <i class="bi bi-x-circle"></i> Not Recommended
                                        </span>
                                    {% endif %}
                                </div>
                                <div class="small text-muted">
                                    {% if review.get('Date Added') %}
                                        <div>{{ review['Date Added'] }}</div>
                                    {% endif %}
                                    {% if review['Age'] %}
                                        <div>Age {{ review['Age'] }}</div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        
                        <p class="card-text">{{ review['Review Text'] or 'No review text provided.' }}</p>
                        

                    </div>
                </div>
                {% endfor %}
                
                {% if reviews|length > 10 %}
                <div class="text-center mt-4">
                    <button type="button" class="btn btn-outline-primary" onclick="loadMoreReviews()">
                        <i class="bi bi-arrow-down-circle"></i> Load More Reviews
                    </button>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    {% else %}
    <!-- No Reviews Yet -->
    <div class="text-center py-5">
        <div class="mb-4">
            <i class="bi bi-chat-square-text display-1 text-muted"></i>
        </div>
        <h4 class="fw-bold text-muted mb-3">No Reviews Yet</h4>
        <p class="text-muted mb-4">Be the first to share your experience with this product!</p>
        <a href="{{ url_for('product.add_review_form', clothing_id=product['Clothing ID']) }}" 
           class="btn btn-primary btn-lg">
            <i class="bi bi-pencil-square"></i> Write the First Review
        </a>
    </div>
    {% endif %}

    <!-- Related Products -->
    <div class="mt-5">
        <h4 class="fw-bold mb-4">
            <i class="bi bi-collection text-success"></i> You Might Also Like
        </h4>
        <div class="text-center py-4">
            <a href="{{ url_for('main.search', department=product['Department Name']) }}" 
               class="btn btn-outline-primary">
                <i class="bi bi-grid"></i> Browse Similar Products
            </a>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
function shareProduct() {
    if (navigator.share) {
        navigator.share({
            title: '{{ product["Clothes Title"] or product["Title"] }}',
            text: 'Check out this product!',
            url: window.location.href
        }).catch(console.error);
    } else {
        // Fallback: copy to clipboard
        navigator.clipboard.writeText(window.location.href).then(function() {
            alert('Product link copied to clipboard!');
        }).catch(function() {
            alert('Unable to copy link. Please copy the URL manually.');
        });
    }
}





// Load more reviews functionality
let currentPage = 1;
let isLoading = false;

function loadMoreReviews() {
    if (isLoading) return;
    
    isLoading = true;
    const loadMoreBtn = document.querySelector('button[onclick="loadMoreReviews()"]');
    const originalText = loadMoreBtn.innerHTML;
    
    loadMoreBtn.innerHTML = '<i class="bi bi-hourglass-split"></i> Loading...';
    loadMoreBtn.disabled = true;
    
    const reviewsContainer = document.getElementById('reviewsContainer');
    const clothingId = reviewsContainer.getAttribute('data-clothing-id');
    currentPage += 1;
    
    fetch(`/api/reviews/${clothingId}?page=${currentPage}`)
        .then(response => response.json())
        .then(data => {
            if (data.reviews && data.reviews.length > 0) {
                appendReviewsToContainer(data.reviews);
                
                // Hide load more button if no more reviews
                if (!data.has_more) {
                    loadMoreBtn.style.display = 'none';
                }
            } else {
                loadMoreBtn.style.display = 'none';
            }
        })
        .catch(error => {
            console.error('Error loading more reviews:', error);
            alert('Error loading more reviews. Please try again.');
        })
        .finally(() => {
            isLoading = false;
            loadMoreBtn.innerHTML = originalText;
            loadMoreBtn.disabled = false;
        });
}

function appendReviewsToContainer(reviews) {
    const reviewsContainer = document.getElementById('reviewsContainer');
    const loadMoreButton = reviewsContainer.querySelector('.text-center');
    
    reviews.forEach(review => {
        const reviewCard = createReviewCard(review);
        
        // Insert before the load more button
        if (loadMoreButton) {
            reviewsContainer.insertBefore(reviewCard, loadMoreButton);
        } else {
            reviewsContainer.appendChild(reviewCard);
        }
    });
}

function createReviewCard(review) {
    const card = document.createElement('div');
    card.className = 'card border-0 shadow-sm mb-3' + (review.is_new ? ' border-primary' : '');
    
    // Generate star rating HTML
    let starsHtml = '';
    for (let i = 0; i < 5; i++) {
        if (i < Math.floor(review.rating)) {
            starsHtml += '<i class="bi bi-star-fill text-warning"></i>';
        } else if (i < review.rating && (review.rating - i) >= 0.5) {
            starsHtml += '<i class="bi bi-star-half text-warning"></i>';
        } else {
            starsHtml += '<i class="bi bi-star text-muted"></i>';
        }
    }
    
    const ratingText = review.rating.toFixed(1);
    
    // Format date
    const dateHtml = review.date_added ? `<div>${review.date_added}</div>` : '';
    const ageHtml = review.age ? `<div>Age ${review.age}</div>` : '';
    
    card.innerHTML = `
        <div class="card-body">
            <div class="d-flex justify-content-between align-items-start mb-3">
                <div>
                    <h6 class="card-title fw-bold mb-1 text-dark">
                        ${review.title}
                        ${review.is_new ? '<span class="badge bg-primary ms-2"><i class="bi bi-star"></i> New Review</span>' : ''}
                    </h6>
                    <div class="review-rating">
                        ${starsHtml}
                    </div>
                </div>
                <div class="text-end">
                    <div class="d-flex align-items-center mb-1">
                        ${review.recommended == 1 ? 
                            '<span class="badge bg-success"><i class="bi bi-check-circle"></i> Recommended</span>' :
                            '<span class="badge bg-secondary"><i class="bi bi-x-circle"></i> Not Recommended</span>'
                        }
                    </div>
                    <div class="small text-muted">
                        ${dateHtml}
                        ${ageHtml}
                    </div>
                </div>
            </div>
            
            <p class="card-text">${review.review_text || 'No review text provided.'}</p>
        </div>
    `;
    
    // Add animation
    card.style.opacity = '0';
    card.style.transform = 'translateY(20px)';
    
    setTimeout(() => {
        card.style.transition = 'all 0.3s ease';
        card.style.opacity = '1';
        card.style.transform = 'translateY(0)';
    }, 100);
    
    return card;
}

// Initialize tooltips and review filtering
document.addEventListener('DOMContentLoaded', function() {
    // Initialize global variables for review pagination
    currentPage = 1;
    currentFilter = 'all';
    currentSort = 'newest';
    
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });
    
    // Add product image placeholder animation
    addProductImagePlaceholder();
    
    // Add scroll-to-review functionality
    addScrollToReview();
});

function addProductImagePlaceholder() {
    // Add a placeholder for product images (could be enhanced with actual images)
    const actionCard = document.querySelector('.sticky-top .card-body');
    if (actionCard) {
        const imagePlaceholder = document.createElement('div');
        imagePlaceholder.className = 'mb-3';
        imagePlaceholder.innerHTML = `
            <div class="product-image-placeholder bg-light rounded d-flex align-items-center justify-content-center" 
                 style="height: 200px; border: 2px dashed #dee2e6;">
                <div class="text-center text-muted">
                    <i class="bi bi-image display-4"></i>
                    <div class="mt-2">Product Image</div>
                    <small>Placeholder for product photo</small>
                </div>
            </div>
        `;
        
        // Insert before the "Love this product?" heading
        const heading = actionCard.querySelector('h5');
        if (heading) {
            actionCard.insertBefore(imagePlaceholder, heading);
        }
    }
}

function addScrollToReview() {
    // Add smooth scroll to reviews section
    const reviewLinks = document.querySelectorAll('a[href="#reviews"]');
    reviewLinks.forEach(link => {
        link.addEventListener('click', function(e) {
            e.preventDefault();
            const reviewsSection = document.getElementById('reviewsContainer');
            if (reviewsSection) {
                reviewsSection.scrollIntoView({
                    behavior: 'smooth',
                    block: 'start'
                });
            }
        });
    });
}
</script>
{% endblock %}

<style>
.rating-display .bi-star-fill,
.rating-display .bi-star {
    font-size: 1.2rem;
}

.review-rating .bi-star-fill,
.review-rating .bi-star {
    font-size: 0.9rem;
}

.sticky-top {
    top: 1rem;
}

.reviews-container .card {
    transition: box-shadow 0.2s ease;
}

.reviews-container .card:hover {
    box-shadow: 0 0.25rem 0.75rem rgba(0, 0, 0, 0.1) !important;
}

.product-badges .badge {
    font-size: 0.75rem;
}

@media (max-width: 992px) {
    .sticky-top {
        position: static !important;
    }
}

@media (max-width: 768px) {
    .rating-display {
        text-align: start !important;
    }
    
    .card-title {
        font-size: 1.1rem;
    }
}

/* Smooth scrolling for better UX */
html {
    scroll-behavior: smooth;
}

/* Custom animations */
@keyframes fadeIn {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
}

.card {
    animation: fadeIn 0.5s ease-in-out;
}
</style>
