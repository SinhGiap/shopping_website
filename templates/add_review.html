{% extends "base.html" %}

{% block title %}Write a Review - {{ product['Clothes Title'] or product['Title'] }}{% endblock %}

{% block content %}
<div class="container my-4">
    <!-- Breadcrumb -->
    <nav aria-label="breadcrumb" class="mb-4">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{{ url_for('home') }}">Home</a></li>
            <li class="breadcrumb-item"><a href="{{ url_for('product_detail', clothing_id=product['Clothing ID']) }}">{{ product['Clothes Title'] or product['Title'] }}</a></li>
            <li class="breadcrumb-item active">Write Review</li>
        </ol>
    </nav>

    <div class="row justify-content-center">
        <div class="col-lg-8">
            <!-- Product Summary -->
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-md-8">
                            <h5 class="card-title fw-bold mb-2">{{ product['Clothes Title'] or product['Title'] }}</h5>
                            <p class="text-muted mb-0">{{ (product['Clothes Description'] or '')[:100] }}{% if (product['Clothes Description'] or '')|length > 100 %}...{% endif %}</p>
                        </div>
                        <div class="col-md-4 text-md-end">
                            <div class="product-badges">
                                {% if product['Class Name'] %}
                                    <span class="badge bg-primary">{{ product['Class Name'] }}</span>
                                {% endif %}
                                {% if product['Department Name'] %}
                                    <span class="badge bg-success">{{ product['Department Name'] }}</span>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Review Form -->
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0">
                        <i class="bi bi-pencil-square"></i> Write Your Review
                    </h4>
                    <small>Share your experience to help other shoppers</small>
                </div>
                <div class="card-body">
                    <form id="reviewForm" action="{{ url_for('submit_review') }}" method="POST">
                        <input type="hidden" name="clothing_id" value="{{ product['Clothing ID'] }}">
                        
                        <!-- Review Title -->
                        <div class="mb-4">
                            <label for="title" class="form-label fw-bold">
                                <i class="bi bi-type text-primary"></i> Review Title *
                            </label>
                            <input type="text" class="form-control form-control-lg" id="title" name="title" 
                                   placeholder="Summarize your experience..." required maxlength="200">
                            <div class="form-text">Give your review a descriptive title (max 200 characters)</div>
                        </div>

                        <!-- Rating -->
                        <div class="mb-4">
                            <label class="form-label fw-bold">
                                <i class="bi bi-star text-warning"></i> Overall Rating *
                            </label>
                            <div class="rating-input mb-2">
                                <div class="btn-group" role="group" aria-label="Rating">
                                    {% for i in range(1, 6) %}
                                    <input type="radio" class="btn-check" name="rating" id="rating{{ i }}" value="{{ i }}" required>
                                    <label class="btn btn-outline-warning" for="rating{{ i }}">
                                        {{ i }} <i class="bi bi-star"></i>
                                    </label>
                                    {% endfor %}
                                </div>
                            </div>
                            <div class="form-text">Rate from 1 (poor) to 5 (excellent)</div>
                        </div>

                        <!-- Review Text -->
                        <div class="mb-4">
                            <label for="review_text" class="form-label fw-bold">
                                <i class="bi bi-chat-square-text text-success"></i> Your Review *
                            </label>
                            <textarea class="form-control" id="review_text" name="review_text" rows="6" 
                                      placeholder="Tell us about your experience with this product. What did you like? What could be improved? How does it fit?" 
                                      required minlength="10"></textarea>
                            <div class="form-text">
                                <span id="charCount">0</span> characters. Minimum 10 characters required.
                            </div>
                        </div>

                        <!-- Recommendation -->
                        <div class="mb-4">
                            <label class="form-label fw-bold">
                                <i class="bi bi-heart text-danger"></i> Would you recommend this product?
                            </label>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="radio" name="recommended" id="recommend_yes" value="1" checked>
                                <label class="form-check-label" for="recommend_yes">
                                    <i class="bi bi-hand-thumbs-up text-success"></i> Yes, I'd recommend it
                                </label>
                            </div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="radio" name="recommended" id="recommend_no" value="0">
                                <label class="form-check-label" for="recommend_no">
                                    <i class="bi bi-hand-thumbs-down text-danger"></i> No, I wouldn't recommend it
                                </label>
                            </div>
                        </div>

                        <!-- ML Prediction Section -->
                        <div class="mb-4">
                            <div class="card bg-light border-0">
                                <div class="card-body">
                                    <h6 class="card-title">
                                        <i class="bi bi-robot text-info"></i> AI Prediction
                                    </h6>
                                    <p class="card-text text-muted mb-3">
                                        Our machine learning model will predict if you'd recommend this product based on your review.
                                    </p>
                                    <button type="button" class="btn btn-info btn-sm" id="getPrediction">
                                        <i class="bi bi-magic"></i> Get AI Prediction
                                    </button>
                                    <div id="predictionResult" class="mt-3" style="display: none;"></div>
                                </div>
                            </div>
                        </div>

                        <!-- Submit Button -->
                        <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                            <a href="{{ url_for('product_detail', clothing_id=product['Clothing ID']) }}" 
                               class="btn btn-outline-secondary me-md-2">
                                <i class="bi bi-arrow-left"></i> Cancel
                            </a>
                            <button type="submit" class="btn btn-primary btn-lg">
                                <i class="bi bi-check-circle"></i> Submit Review
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Tips for Writing Reviews -->
            <div class="card border-0 bg-light mt-4">
                <div class="card-body">
                    <h6 class="card-title">
                        <i class="bi bi-lightbulb text-warning"></i> Tips for Writing Helpful Reviews
                    </h6>
                    <ul class="list-unstyled mb-0">
                        <li class="mb-2">
                            <i class="bi bi-check text-success"></i> 
                            <strong>Be specific:</strong> Mention fit, quality, comfort, and appearance
                        </li>
                        <li class="mb-2">
                            <i class="bi bi-check text-success"></i> 
                            <strong>Be honest:</strong> Share both positives and areas for improvement
                        </li>
                        <li class="mb-2">
                            <i class="bi bi-check text-success"></i> 
                            <strong>Include context:</strong> Mention your size, occasion of use, etc.
                        </li>
                        <li class="mb-0">
                            <i class="bi bi-check text-success"></i> 
                            <strong>Be respectful:</strong> Keep your review constructive and helpful
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const reviewTextarea = document.getElementById('review_text');
    const charCount = document.getElementById('charCount');
    const getPredictionBtn = document.getElementById('getPrediction');
    const predictionResult = document.getElementById('predictionResult');
    const ratingInputs = document.querySelectorAll('input[name="rating"]');
    
    // Character counter
    reviewTextarea.addEventListener('input', function() {
        const count = this.value.length;
        charCount.textContent = count;
        
        if (count < 10) {
            charCount.classList.add('text-danger');
            charCount.classList.remove('text-success');
        } else {
            charCount.classList.add('text-success');
            charCount.classList.remove('text-danger');
        }
    });
    
    // Rating visual feedback
    ratingInputs.forEach(function(input) {
        input.addEventListener('change', function() {
            const rating = parseInt(this.value);
            const labels = document.querySelectorAll('label[for^="rating"]');
            
            labels.forEach(function(label, index) {
                const star = label.querySelector('i');
                if (index < rating) {
                    star.classList.remove('bi-star');
                    star.classList.add('bi-star-fill');
                    label.classList.remove('btn-outline-warning');
                    label.classList.add('btn-warning');
                } else {
                    star.classList.remove('bi-star-fill');
                    star.classList.add('bi-star');
                    label.classList.remove('btn-warning');
                    label.classList.add('btn-outline-warning');
                }
            });
        });
    });
    
    // ML Prediction
    getPredictionBtn.addEventListener('click', function() {
        const title = document.getElementById('title').value.trim();
        const reviewText = document.getElementById('review_text').value.trim();
        const rating = document.querySelector('input[name="rating"]:checked')?.value;
        
        if (!title || !reviewText || !rating) {
            alert('Please fill in the title, review text, and rating before getting a prediction.');
            return;
        }
        
        if (reviewText.length < 10) {
            alert('Please write at least 10 characters in your review.');
            return;
        }
        
        // Show loading state
        getPredictionBtn.innerHTML = '<i class="bi bi-hourglass-split"></i> Analyzing...';
        getPredictionBtn.disabled = true;
        
        // Make prediction request
        fetch('{{ url_for("predict_recommendation") }}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                title: title,
                text: reviewText,
                rating: parseInt(rating),
                clothing_id: parseInt('{{ product["Clothing ID"] }}'),
                division: '{{ product.get("Division Name", "General") }}',
                department: '{{ product.get("Department Name", "Tops") }}',
                class_name: '{{ product.get("Class Name", "Blouses") }}'
            })
        })
        .then(response => response.json())
        .then(data => {
            showPredictionResult(data);
        })
        .catch(error => {
            console.error('Error:', error);
            showPredictionError();
        })
        .finally(() => {
            getPredictionBtn.innerHTML = '<i class="bi bi-magic"></i> Get AI Prediction';
            getPredictionBtn.disabled = false;
        });
    });
    
    function showPredictionResult(data) {
        const prediction = data.prediction;
        const confidence = (data.confidence * 100).toFixed(1);
        const status = data.status || 'success';
        
        let resultHtml = '';
        
        if (prediction === 1) {
            resultHtml = `
                <div class="alert alert-success border-0">
                    <div class="d-flex align-items-center">
                        <i class="bi bi-check-circle-fill fs-4 me-3"></i>
                        <div>
                            <h6 class="mb-1">AI Prediction: You'll likely RECOMMEND this product</h6>
                            <small>Confidence: ${confidence}%</small>
                            ${status === 'fallback' ? '<br><small class="text-muted">(Based on simplified analysis)</small>' : ''}
                        </div>
                    </div>
                </div>
            `;
        } else {
            resultHtml = `
                <div class="alert alert-warning border-0">
                    <div class="d-flex align-items-center">
                        <i class="bi bi-exclamation-triangle-fill fs-4 me-3"></i>
                        <div>
                            <h6 class="mb-1">AI Prediction: You might NOT recommend this product</h6>
                            <small>Confidence: ${confidence}%</small>
                            ${status === 'fallback' ? '<br><small class="text-muted">(Based on simplified analysis)</small>' : ''}
                        </div>
                    </div>
                </div>
            `;
        }
        
        if (data.model_predictions && Object.keys(data.model_predictions).length > 0) {
            resultHtml += `
                <div class="mt-2">
                    <small class="text-muted">
                        <strong>Model details:</strong> 
                        ${Object.entries(data.model_predictions).map(([model, pred]) => 
                            `${model}: ${pred === 1 ? 'Recommend' : 'Not recommend'}`
                        ).join(', ')}
                    </small>
                </div>
            `;
        }
        
        predictionResult.innerHTML = resultHtml;
        predictionResult.style.display = 'block';
        predictionResult.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }
    
    function showPredictionError() {
        predictionResult.innerHTML = `
            <div class="alert alert-danger border-0">
                <div class="d-flex align-items-center">
                    <i class="bi bi-exclamation-circle-fill fs-4 me-3"></i>
                    <div>
                        <h6 class="mb-1">Unable to get AI prediction</h6>
                        <small>Please try again or submit your review without the prediction.</small>
                    </div>
                </div>
            </div>
        `;
        predictionResult.style.display = 'block';
    }
    
    // Form validation
    const form = document.getElementById('reviewForm');
    form.addEventListener('submit', function(e) {
        const title = document.getElementById('title').value.trim();
        const reviewText = document.getElementById('review_text').value.trim();
        const rating = document.querySelector('input[name="rating"]:checked');
        
        if (!title || !reviewText || !rating) {
            e.preventDefault();
            alert('Please fill in all required fields.');
            return;
        }
        
        if (reviewText.length < 10) {
            e.preventDefault();
            alert('Please write at least 10 characters in your review.');
            reviewTextarea.focus();
            return;
        }
        
        // Show submission loading state
        const submitBtn = form.querySelector('button[type="submit"]');
        submitBtn.innerHTML = '<i class="bi bi-hourglass-split"></i> Submitting...';
        submitBtn.disabled = true;
    });
});
</script>
{% endblock %}

{% block extra_head %}
<style>
.rating-input .btn {
    border-radius: 0.375rem;
    margin-right: 0.25rem;
}

.rating-input .btn-check:checked + .btn {
    transform: scale(1.05);
}

.card-header {
    border-radius: 0.375rem 0.375rem 0 0 !important;
}

.form-control:focus {
    border-color: var(--bs-primary);
    box-shadow: 0 0 0 0.2rem rgba(var(--bs-primary-rgb), 0.25);
}

.alert {
    border-radius: 0.5rem;
}

.product-badges .badge {
    font-size: 0.75rem;
    margin-left: 0.25rem;
}

@media (max-width: 768px) {
    .rating-input .btn {
        font-size: 0.8rem;
        padding: 0.375rem 0.5rem;
    }
    
    .d-grid.gap-2.d-md-flex {
        display: grid !important;
        gap: 0.5rem !important;
    }
}

/* Smooth animations */
.alert {
    animation: slideIn 0.3s ease-in-out;
}

@keyframes slideIn {
    from {
        opacity: 0;
        transform: translateY(-10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* Character counter styling */
#charCount.text-danger {
    font-weight: bold;
}

#charCount.text-success {
    font-weight: bold;
}
</style>
{% endblock %}
